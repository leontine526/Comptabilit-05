<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="SmartOHADA - Solution de comptabilité OHADA avec IA">
    <meta name="theme-color" content="#3a56b4">
    <title>{% block title %}{% if title %}{{ title }} | {% endif %}SmartOHADA{% endblock %}</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-colors.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/journal.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-widgets.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern-nav.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/social.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">

    {% block styles %}{% endblock %}
</head>
<body class="{% if current_user.is_authenticated %}user-authenticated{% endif %}">
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="{{ url_for('static', filename='images/smartohada-logo.svg') }}" alt="SmartOHADA Logo" height="60">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0 main-nav">
                    {% if current_user.is_authenticated %}
                        <!-- Navigation principale avec onglets majeurs -->
                        <li class="nav-item">
                            <a class="nav-link nav-main-item {% if request.endpoint == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard') }}">
                                <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                            </a>
                        </li>

                        <!-- Module Comptabilité -->
                        <li class="nav-item dropdown">
                            <a class="nav-link nav-main-item dropdown-toggle {% if request.endpoint in ['exercises_list', 'exercise_new', 'transactions_list', 'transaction_new', 'accounts_list', 'account_new'] %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-calculator me-1"></i>Comptabilité
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark dropdown-columns">
                                <div class="row">
                                    <div class="col-md-6">
                                        <li><h6 class="dropdown-header">Exercices comptables</h6></li>
                                        <li><a class="dropdown-item" href="{{ url_for('exercises_list') }}"><i class="fas fa-book me-2"></i>Liste des exercices</a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('exercise_new') }}"><i class="fas fa-plus-circle me-2"></i>Nouvel exercice</a></li>
                                        <li><hr class="dropdown-divider"></li>

                                        <li><h6 class="dropdown-header">Plan comptable</h6></li>
                                        <li><a class="dropdown-item" href="{{ url_for('accounts_list', exercise_id=current_user.exercises.first().id) if current_user.exercises.first() else url_for('exercise_new') }}"><i class="fas fa-sitemap me-2"></i>Consulter le plan</a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('account_new', exercise_id=current_user.exercises.first().id) if current_user.exercises.first() else url_for('exercise_new') }}"><i class="fas fa-plus-square me-2"></i>Ajouter un compte</a></li>
                                    </div>
                                    <div class="col-md-6">
                                        <li><h6 class="dropdown-header">Journal comptable</h6></li>
                                        <li><a class="dropdown-item" href="{{ url_for('transactions_list', exercise_id=current_user.exercises.first().id) if current_user.exercises.first() else url_for('exercise_new') }}"><i class="fas fa-file-invoice me-2"></i>Journal général</a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('transaction_new', exercise_id=current_user.exercises.first().id) if current_user.exercises.first() else url_for('exercise_new') }}"><i class="fas fa-edit me-2"></i>Saisie d'écritures</a></li>

                                        <li><hr class="dropdown-divider"></li>
                                        <li><h6 class="dropdown-header">États financiers</h6></li>
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-balance-scale me-2"></i>Bilan</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-chart-line me-2"></i>Compte de résultat</a></li>
                                    </div>
                                </div>
                            </ul>
                        </li>

                        <!-- Module Document -->
                        <li class="nav-item dropdown">
                            <a class="nav-link nav-main-item dropdown-toggle {% if request.endpoint in ['documents_list', 'document_upload', 'document_view', 'document_process'] %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-file-alt me-1"></i>Documents
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark">
                                <li><h6 class="dropdown-header">Gestion documentaire</h6></li>
                                <li><a class="dropdown-item" href="{{ url_for('documents_list', exercise_id=current_user.exercises.first().id) if current_user.exercises.first() else url_for('exercise_new') }}"><i class="fas fa-folder-open me-2"></i>Mes documents</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('document_upload', exercise_id=current_user.exercises.first().id) if current_user.exercises.first() else url_for('exercise_new') }}"><i class="fas fa-upload me-2"></i>Importer un document</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Outils</h6></li>
                                <li><a class="dropdown-item" href="{{ url_for('text_processing') }}"><i class="fas fa-language me-2"></i>Traitement de texte</a></li>
                                <li><a class="dropdown-item" href="#"><i class="fas fa-file-export me-2"></i>Exportation</a></li>
                            </ul>
                        </li>

                        <!-- Module analyse IA -->
                        <li class="nav-item dropdown">
                            <a class="nav-link nav-main-item dropdown-toggle {% if request.endpoint in ['exercise_solver_form', 'exercise_examples_list', 'exercise_solutions_list', 'exercise_solver_complete'] %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-brain me-1"></i>Analyse IA
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark">
                                <li><h6 class="dropdown-header">Analyse comptable</h6></li>
                                <li><a class="dropdown-item" href="#"><i class="fas fa-chart-pie me-2"></i>Analyse d'exercice</a></li>
                                <li><a class="dropdown-item" href="#"><i class="fas fa-lightbulb me-2"></i>Recommandations</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Apprentissage</h6></li>
                                <li><a class="dropdown-item" href="{{ url_for('exercise_solver_form') }}"><i class="fas fa-graduation-cap me-2"></i>Résoudre un exercice</a></li>
                                <li><a class="dropdown-item font-weight-bold text-primary" href="{{ url_for('exercise_solver_form') }}"><i class="fas fa-star text-warning me-1"></i>Résolution complète</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('exercise_examples_list') }}"><i class="fas fa-book-open me-2"></i>Exemples résolus</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('exercise_solutions_list') }}"><i class="fas fa-clipboard-check me-2"></i>Mes solutions</a></li>
                            </ul>
                        </li>

                        <!-- Module Social -->
                        <li class="nav-item dropdown">
                            <a class="nav-link nav-main-item dropdown-toggle social-nav-link {% if request.endpoint in ['feed', 'stories', 'workgroups_list', 'workgroup_new'] %}active{% endif %}" href="{{ url_for('feed') }}" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-share-alt me-1"></i>Social
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark">
                                <li><h6 class="dropdown-header">Réseau social</h6></li>
                                <li><a class="dropdown-item" href="{{ url_for('feed') }}"><i class="fas fa-stream me-2"></i>Fil d'actualité</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('stories') }}"><i class="fas fa-history me-2"></i>Stories</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Collaboration</h6></li>
                                <li><a class="dropdown-item" href="{{ url_for('workgroups_list') }}"><i class="fas fa-users me-2"></i>Groupes de travail</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('workgroup_new') }}"><i class="fas fa-user-plus me-2"></i>Nouveau groupe</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('messages_list') }}"><i class="fas fa-comments me-2"></i>Messagerie</a></li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link nav-main-item {% if request.path == '/' %}active{% endif %}" href="/">
                                <i class="fas fa-home me-1"></i>Accueil
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link nav-main-item {% if request.path == '/about' %}active{% endif %}" href="/about">
                                <i class="fas fa-info-circle me-1"></i>À propos
                            </a>
                        </li>
                    {% endif %}
                </ul>

                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    {% if current_user.is_authenticated %}
                        <!-- Notifications Dropdown -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle position-relative" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-bell me-1"></i>
                                {% if current_user.unread_notifications_count > 0 %}
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                        {{ current_user.unread_notifications_count }}
                                        <span class="visually-hidden">notifications non lues</span>
                                    </span>
                                {% endif %}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end notification-dropdown">
                                <li>
                                    <h6 class="dropdown-header">Notifications</h6>
                                </li>
                                {% if current_user.recent_notifications %}
                                    {% for notification in current_user.recent_notifications %}
                                        <li>
                                            <a class="dropdown-item notification-item {% if not notification.is_read %}unread{% endif %}" 
                                               href="{{ notification.source_url or url_for('notifications_list') }}">
                                                {% if notification.notification_type == 'message' %}
                                                    <i class="fas fa-comment text-primary me-2"></i>
                                                {% elif notification.notification_type == 'invite' %}
                                                    <i class="fas fa-user-plus text-success me-2"></i>
                                                {% elif notification.notification_type == 'share' %}
                                                    <i class="fas fa-share-alt text-info me-2"></i>
                                                {% elif notification.notification_type == 'note' %}
                                                    <i class="fas fa-sticky-note text-warning me-2"></i>
                                                {% else %}
                                                    <i class="fas fa-bell text-secondary me-2"></i>
                                                {% endif %}
                                                <div>
                                                    <strong class="d-block">{{ notification.title }}</strong>
                                                    <small class="text-muted">{{ notification.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                                                </div>
                                            </a>
                                        </li>
                                    {% endfor %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-center" href="{{ url_for('notifications_list') }}">
                                            Voir toutes les notifications
                                        </a>
                                    </li>
                                {% else %}
                                    <li>
                                        <div class="dropdown-item text-center">
                                            <i class="fas fa-bell-slash me-2"></i>Aucune notification
                                        </div>
                                    </li>
                                {% endif %}
                            </ul>
                        </li>

                        <!-- Bouton de déconnexion rapide -->
                        <li class="nav-item">
                            <a class="nav-link btn btn-outline-danger btn-sm ms-2" href="{{ url_for('logout') }}" title="Déconnexion">
                                <i class="fas fa-sign-out-alt me-1"></i>Déconnexion
                            </a>
                        </li>

                        <!-- User Profile Dropdown -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>{{ current_user.username }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
                                <li><a class="dropdown-item" href="{{ url_for('profile') }}">Profil</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('about') }}">À propos</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ url_for('logout') }}">Déconnexion</a></li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="/login">
                                <i class="fas fa-sign-in-alt me-1"></i>Connexion
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/register">
                                <i class="fas fa-user-plus me-1"></i>Inscription
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Flash Messages -->
    <div class="container mt-3">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Main Content -->
    <main class="flex-grow-1">

<div class="page-header">
    <div class="container-fluid">
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="d-flex align-items-center">
                    {% if request.path != '/dashboard' and request.path != '/' and request.path != '/index' %}
                    <a href="javascript:history.back()" class="btn btn-outline-secondary me-2" title="Retour">
                        <i data-feather="arrow-left"></i>
                    </a>
                    {% endif %}
                    <h2 class="mb-0">{{ title }}</h2>
                </div>
                {% block breadcrumbs %}{% endblock %}
            </div>
            <div class="col-md-6 d-flex justify-content-md-end align-items-center">
                {% block page_actions %}{% endblock %}
            </div>
        </div>
    </div>
</div>

        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer mt-auto py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-3 mb-md-0">
                    <h5 class="mb-3">SmartOHADA</h5>
                    <p class="text-muted mb-0">Une solution complète de gestion comptable basée sur le référentiel OHADA, avec traitement automatisé des documents et analyse intelligente.</p>
                </div>
                <div class="col-md-4 mb-3 mb-md-0">
                    <h5 class="mb-3">Navigation Rapide</h5>
                    <ul class="list-unstyled footer-links">
                        <li class="mb-2">
                            <a href="/" class="text-decoration-none">
                                <i class="fas fa-home me-2 text-primary"></i>Page d'accueil
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="/about" class="text-decoration-none">
                                <i class="fas fa-info-circle me-2 text-primary"></i>À propos de Mushaga
                            </a>
                        </li>
                        {% if current_user.is_authenticated %}
                            <li class="mb-2">
                                <a href="{{ url_for('dashboard') }}" class="text-decoration-none">
                                    <i class="fas fa-tachometer-alt me-2 text-primary"></i>Accéder au tableau de bord
                                </a>
                            </li>
                            <li class="mb-2">
                                <a href="{{ url_for('profile') }}" class="text-decoration-none">
                                    <i class="fas fa-user me-2 text-primary"></i>Modifier mon profil
                                </a>
                            </li>
                            <li class="mb-2">
                                <a href="{{ url_for('text_processing') }}" class="text-decoration-none">
                                    <i class="fas fa-file-alt me-2 text-primary"></i>Traitement de texte
                                </a>
                            </li>
                            <li class="mb-2">
                                <a href="{{ url_for('exercise_solver_form') }}" class="text-decoration-none">
                                    <i class="fas fa-graduation-cap me-2 text-primary"></i>Résoudre un exercice
                                </a>
                            </li>
                        {% else %}
                            <li class="mb-2">
                                <a href="/login" class="text-decoration-none">
                                    <i class="fas fa-sign-in-alt me-2 text-primary"></i>Se connecter
                                </a>
                            </li>
                            <li class="mb-2">
                                <a href="/register" class="text-decoration-none">
                                    <i class="fas fa-user-plus me-2 text-primary"></i>Créer un compte
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5 class="mb-3">Contact</h5>
                    <div class="contact-info">
                        <p class="mb-2 fw-bold"><i class="fas fa-envelope me-2 text-primary"></i>kirizamushaga@gmail.com</p>
                        <p class="mb-2 fw-bold"><i class="fas fa-phone me-2 text-primary"></i>+243 820 740 027</p>
                        <p class="mb-2 fw-bold"><i class="fas fa-map-marker-alt me-2 text-primary"></i>Bumba, Congo (RDC)</p>
                        <p class="mb-0 fw-bold"><i class="fab fa-github me-2 text-primary"></i>github.com/mushagakiriza</p>
                    </div>
                </div>
            </div>
            <hr class="my-4">
            <div class="row">
                <div class="col-md-6 text-center text-md-start">
                    <p class="mb-0 fw-bold">© 2025 SmartOHADA. Tous droits réservés.</p>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <p class="mb-0 fw-bold">
                        <span class="highlight-text">Développé par Mushaga Kiriza</span>
                        <span class="ms-2 badge bg-primary rounded-pill">OHADA Premium</span>
                    </p>
                </div>
            </div>
            <div class="mt-3 text-center">
                <div class="legal-notice p-2 bg-dark rounded">
                    <span class="text-gradient fw-bold"><i class="fas fa-shield-alt me-1"></i> fiabilité • précision • excellence</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/password_toggle.js') }}"></script>
    <script src="{{ url_for('static', filename='js/exercise_form.js') }}"></script>
    <script src="{{ url_for('static', filename='js/responsive-helper.js') }}"></script>
    <script src="{{ url_for('static', filename='js/page-optimizer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/form-validator.js') }}"></script>
    <script src="{{ url_for('static', filename='js/realtime-enhanced.js') }}"></script>

    <!-- Son de notification -->
    <audio id="notification-sound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/notification.wav') }}" type="audio/wav">
    </audio>

    <!-- Scripts pour améliorer la stabilité -->
    <script>
        // Récupération de l'état des formulaires pour restauration en cas d'erreur
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('form:not([data-no-autosave])');
            forms.forEach(form => {
                // Récupérer les données sauvegardées si elles existent
                const formId = form.id || form.getAttribute('name') || 'default-form';
                const savedData = localStorage.getItem('form-' + formId);
                if (savedData) {
                    try {
                        const formData = JSON.parse(savedData);
                        Object.keys(formData).forEach(key => {
                            const input = form.querySelector(`[name="${key}"]`);
                            if (input && !input.value) {
                                input.value = formData[key];
                            }
                        });
                    } catch (e) {
                        console.error('Erreur lors de la restauration du formulaire:', e);
                    }
                }

                // Sauvegarder les données à chaque changement
                form.addEventListener('input', function(e) {
                    if (e.target.type !== 'password') {
                        const formData = {};
                        new FormData(form).forEach((value, key) => {
                            formData[key] = value;
                        });
                        localStorage.setItem('form-' + formId, JSON.stringify(formData));
                    }
                });

                // Nettoyer après soumission réussie
                form.addEventListener('submit', function() {
                    localStorage.removeItem('form-' + formId);
                });
            });

            // Gestion des erreurs JavaScript
            window.addEventListener('error', function(e) {
                console.error('Erreur JavaScript interceptée:', e.message, 'à', e.filename, 'ligne', e.lineno);
                // Éviter d'afficher des alertes intrusives, mais enregistrer l'erreur
                return false;
            });

            // Récupération des images en cas d'échec
            document.querySelectorAll('img').forEach(img => {
                img.addEventListener('error', function() {
                    if (!this.hasAttribute('data-error-handled')) {
                        this.setAttribute('data-error-handled', 'true');
                        // Essayer de charger une image de remplacement
                        this.src = "{{ url_for('static', filename='images/placeholder.png') }}";
                    }
                });
            });
        });
    </script>
    {% block scripts %}{% endblock %}

    <script>
    // Ajouter une classe au body selon la taille de l'écran
    document.addEventListener('DOMContentLoaded', function() {
        function updateBodyClass() {
            const width = window.innerWidth;
            document.body.classList.remove('device-xs', 'device-sm', 'device-md', 'device-lg', 'device-xl');

            if (width < 576) {
                document.body.classList.add('device-xs');
            } else if (width < 768) {
                document.body.classList.add('device-sm');
            } else if (width < 992) {
                document.body.classList.add('device-md');
            } else if (width < 1200) {
                document.body.classList.add('device-lg');
            } else {
                document.body.classList.add('device-xl');
            }
        }

        updateBodyClass();
        window.addEventListener('resize', updateBodyClass);
    });
    </script>
</body>
</html>