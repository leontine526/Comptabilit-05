{% extends "base.html" %}

{% block title %}Conversation avec {{ other_user.username }}{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/social.css') }}">
<style>
    .chat-container {
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }

    .chat-message {
        display: flex;
        margin-bottom: 1rem;
        max-width: 80%;
    }

    .chat-message-in {
        align-self: flex-start;
    }

    .chat-message-out {
        align-self: flex-end;
        flex-direction: row-reverse;
        margin-left: auto;
    }

    .message-avatar {
        min-width: 40px;
        margin: 0 0.5rem;
    }

    .message-content {
        padding: 0.75rem 1rem;
        border-radius: 18px;
        background-color: #f1f1f1;
        position: relative;
    }

    .chat-message-out .message-content {
        background-color: #0d6efd;
        color: white;
    }

    .message-time {
        font-size: 0.75rem;
        color: #aaa;
        margin-top: 0.25rem;
    }

    .chat-message-out .message-time {
        color: rgba(255, 255, 255, 0.7);
        text-align: right;
    }

    .chat-input {
        padding: 1rem;
        border-top: 1px solid #eee;
        background-color: white;
    }

    .chat-header {
        padding: 1rem;
        border-bottom: 1px solid #eee;
        background-color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="card chat-container">
        <div class="chat-header d-flex align-items-center">
            <a href="{{ url_for('messages_list') }}" class="btn btn-sm btn-link me-2">
                <i class="bi bi-arrow-left"></i>
            </a>
            <div class="avatar me-2">
                <span class="avatar-initial rounded-circle bg-primary">
                    {{ other_user.username[0]|upper }}
                </span>
            </div>
            <div>
                <h5 class="mb-0">{{ other_user.username }}</h5>
                <small class="text-muted">
                    {% if other_user.is_online %}
                        <span class="text-success">
                            <i class="bi bi-circle-fill"></i> En ligne
                        </span>
                    {% else %}
                        <span class="text-muted">
                            Vu {{ other_user.last_seen.strftime('%d/%m/%Y %H:%M') if other_user.last_seen else "jamais" }}
                        </span>
                    {% endif %}
                </small>
            </div>
        </div>

        <div class="chat-messages" id="chat-messages">
            {% if messages %}
                {% for message in messages %}
                    <div class="chat-message {% if message.sender_id == current_user.id %}chat-message-out{% else %}chat-message-in{% endif %}">
                        <div class="message-avatar">
                            <div class="avatar bg-{% if message.sender_id == current_user.id %}primary{% else %}secondary{% endif %}">
                                <span class="avatar-initial">{{ message.sender.username[0]|upper }}</span>
                            </div>
                        </div>
                        <div class="message-content">
                            <div class="message-text">{{ message.content }}</div>
                            <div class="message-time">{{ message.sent_at.strftime('%H:%M') }}</div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-5">
                    <p class="text-muted">Aucun message. Commencez la conversation !</p>
                </div>
            {% endif %}
        </div>

        <div class="chat-input">
            <form id="message-form" action="{{ url_for('messages_conversation', user_id=other_user.id) }}" method="POST">
                <div class="input-group">
                    <input type="text" class="form-control" id="message-input" name="content" placeholder="Écrivez votre message..." autocomplete="off">
                    <button class="btn btn-primary" type="submit" style="min-width: 60px;">
                        <i class="bi bi-send me-1"></i>
                        <span class="d-none d-sm-inline">Envoyer</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Faire défiler vers le bas pour voir les messages récents
        const chatMessages = document.getElementById('chat-messages');
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Configurer Socket.IO pour les messages en temps réel
        const socket = io();

        // Gestionnaire d'événements pour les nouveaux messages
        socket.on('private_message', function(data) {
            if (data.sender_id === {{ other_user.id }}) {
                // Créer un élément de message
                const messageElement = document.createElement('div');
                messageElement.className = 'chat-message chat-message-in';

                // Format du message
                messageElement.innerHTML = `
                    <div class="message-avatar">
                        <div class="avatar bg-secondary">
                            <span class="avatar-initial">${data.sender_username.charAt(0).toUpperCase()}</span>
                        </div>
                    </div>
                    <div class="message-content">
                        <div class="message-text">${data.message}</div>
                        <div class="message-time">${data.timestamp}</div>
                    </div>
                `;

                // Ajouter le message à la conversation
                chatMessages.appendChild(messageElement);

                // Faire défiler vers le bas
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Jouer un son de notification
                playNotificationSound();
            }
        });

        // Formulaire d'envoi de message
        const messageForm = document.getElementById('message-form');
        if (messageForm) {
            messageForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const messageInput = document.getElementById('message-input');
                const message = messageInput.value.trim();

                if (message) {
                    // Envoyer le formulaire avec AJAX
                    fetch(this.action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams(new FormData(this))
                    })
                    .then(response => {
                        if (response.ok) {
                            // Créer un élément de message
                            const messageElement = document.createElement('div');
                            messageElement.className = 'chat-message chat-message-out';

                            // Format du message
                            messageElement.innerHTML = `
                                <div class="message-avatar">
                                    <div class="avatar bg-primary">
                                        <span class="avatar-initial">{{ current_user.username[0]|upper }}</span>
                                    </div>
                                </div>
                                <div class="message-content">
                                    <div class="message-text">${message}</div>
                                    <div class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                                </div>
                            `;

                            // Ajouter le message à la conversation
                            chatMessages.appendChild(messageElement);

                            // Faire défiler vers le bas
                            chatMessages.scrollTop = chatMessages.scrollHeight;

                            // Réinitialiser l'input
                            messageInput.value = '';
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                    });
                }
            });
        }

        // Fonction pour jouer un son de notification
        function playNotificationSound() {
            const notificationSound = new Audio('/static/sounds/notification.wav');
            notificationSound.volume = 0.5;
            notificationSound.play().catch(err => {
                console.error('Erreur lors de la lecture du son:', err);
            });
        }
    });
</script>
{% endblock %}