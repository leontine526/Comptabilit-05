{% extends "base.html" %}

{% block styles %}
<style>
    .transaction-items {
        border: 1px solid #444;
        border-radius: 5px;
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: rgba(0, 0, 0, 0.2);
    }
    .transaction-item {
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #333;
        border-radius: 5px;
        background-color: #2a2a2a;
    }
    .transaction-item:last-child {
        margin-bottom: 0;
    }
    .remove-item {
        float: right;
    }
    .form-totals {
        padding: 1rem;
        background-color: #343a40;
        border-radius: 5px;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-0">{{ title }}</h1>
        <p class="text-muted">Exercice : {{ exercise.name }}</p>
    </div>
    <div>
        <a href="{{ url_for('transactions_list', exercise_id=exercise.id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Annuler et revenir au journal
        </a>
    </div>
</div>

<form method="POST" id="transactionForm">
    {{ form.hidden_tag() }}
    
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h5 class="mb-0">Informations générales</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            {{ form.reference.label(class="form-label") }}
                            {{ form.reference(class="form-control bg-dark text-light") }}
                            {% if form.reference.errors %}
                                <div class="text-danger">
                                    {% for error in form.reference.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {{ form.transaction_date.label(class="form-label") }}
                            {{ form.transaction_date(class="form-control bg-dark text-light", type="date") }}
                            {% if form.transaction_date.errors %}
                                <div class="text-danger">
                                    {% for error in form.transaction_date.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.description.label(class="form-label") }}
                        {{ form.description(class="form-control bg-dark text-light", rows=3) }}
                        {% if form.description.errors %}
                            <div class="text-danger">
                                {% for error in form.description.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-check">
                        {{ form.is_posted(class="form-check-input") }}
                        {{ form.is_posted.label(class="form-check-label") }}
                        {% if form.is_posted.errors %}
                            <div class="text-danger">
                                {% for error in form.is_posted.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card bg-dark border-primary">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Totaux</h5>
                </div>
                <div class="card-body">
                    <div class="form-totals">
                        <div class="row">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <label class="form-label">Total débit</label>
                                <div class="input-group">
                                    <input type="text" id="totalDebit" class="form-control bg-dark text-light" readonly value="0.00">
                                    <span class="input-group-text">XAF</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Total crédit</label>
                                <div class="input-group">
                                    <input type="text" id="totalCredit" class="form-control bg-dark text-light" readonly value="0.00">
                                    <span class="input-group-text">XAF</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Balance</label>
                            <div class="input-group">
                                <input type="text" id="balance" class="form-control bg-dark text-light" readonly value="0.00">
                                <span class="input-group-text">XAF</span>
                            </div>
                            <div id="balanceStatus" class="mt-2 text-center">
                                <span class="badge bg-danger">Non équilibrée</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Enregistrer l'écriture
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card bg-dark border-secondary mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Lignes d'écriture</h5>
            <button type="button" id="addItemBtn" class="btn btn-sm btn-success">
                <i class="fas fa-plus me-1"></i>Ajouter une ligne
            </button>
        </div>
        <div class="card-body">
            <div class="transaction-items" id="items-container">
                {% for item_form in form.items %}
                    <div class="transaction-item">
                        {{ item_form.id }}
                        <button type="button" class="btn btn-sm btn-outline-danger remove-item">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                {{ item_form.account_id.label(class="form-label") }}
                                <select name="{{ item_form.account_id.name }}" id="{{ item_form.account_id.id }}" class="form-select bg-dark text-light account-select">
                                    <option value="">-- Sélectionnez un compte --</option>
                                    {% for account in accounts %}
                                        <option value="{{ account.id }}" {{ 'selected' if item_form.account_id.data == account.id else '' }}>
                                            {{ account.account_number }} - {{ account.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if item_form.account_id.errors %}
                                    <div class="text-danger">
                                        {% for error in item_form.account_id.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                {{ item_form.description.label(class="form-label") }}
                                {{ item_form.description(class="form-control bg-dark text-light") }}
                                {% if item_form.description.errors %}
                                    <div class="text-danger">
                                        {% for error in item_form.description.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                {{ item_form.debit_amount.label(class="form-label") }}
                                <div class="input-group">
                                    {{ item_form.debit_amount(class="form-control bg-dark text-light debit-amount") }}
                                    <span class="input-group-text">XAF</span>
                                </div>
                                {% if item_form.debit_amount.errors %}
                                    <div class="text-danger">
                                        {% for error in item_form.debit_amount.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                {{ item_form.credit_amount.label(class="form-label") }}
                                <div class="input-group">
                                    {{ item_form.credit_amount(class="form-control bg-dark text-light credit-amount") }}
                                    <span class="input-group-text">XAF</span>
                                </div>
                                {% if item_form.credit_amount.errors %}
                                    <div class="text-danger">
                                        {% for error in item_form.credit_amount.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Calculate totals
        function calculateTotals() {
            let totalDebit = 0;
            let totalCredit = 0;
            
            // Add up all debit and credit amounts
            document.querySelectorAll('.debit-amount').forEach(function(input) {
                const value = parseFloat(input.value) || 0;
                totalDebit += value;
            });
            
            document.querySelectorAll('.credit-amount').forEach(function(input) {
                const value = parseFloat(input.value) || 0;
                totalCredit += value;
            });
            
            // Update totals display
            document.getElementById('totalDebit').value = totalDebit.toFixed(2);
            document.getElementById('totalCredit').value = totalCredit.toFixed(2);
            
            // Calculate balance
            const balance = Math.abs(totalDebit - totalCredit);
            document.getElementById('balance').value = balance.toFixed(2);
            
            // Update balance status
            const balanceStatus = document.getElementById('balanceStatus');
            if (balance < 0.01) {
                balanceStatus.innerHTML = '<span class="badge bg-success">Équilibrée</span>';
            } else {
                balanceStatus.innerHTML = '<span class="badge bg-danger">Non équilibrée</span>';
            }
        }
        
        // Remove transaction item
        function setupRemoveButtons() {
            document.querySelectorAll('.remove-item').forEach(function(button) {
                button.addEventListener('click', function() {
                    // Don't remove if there are only 2 items left
                    const items = document.querySelectorAll('.transaction-item');
                    if (items.length <= 2) {
                        alert('Une écriture doit contenir au moins deux lignes');
                        return;
                    }
                    
                    this.closest('.transaction-item').remove();
                    calculateTotals();
                });
            });
        }
        
        // Add new transaction item
        document.getElementById('addItemBtn').addEventListener('click', function() {
            const container = document.getElementById('items-container');
            const items = document.querySelectorAll('.transaction-item');
            const lastItem = items[items.length - 1];
            
            // Clone the last item
            const newItem = lastItem.cloneNode(true);
            
            // Update IDs and names
            const index = items.length;
            const inputs = newItem.querySelectorAll('input, select');
            inputs.forEach(function(input) {
                const name = input.getAttribute('name');
                const id = input.getAttribute('id');
                
                if (name) {
                    const newName = name.replace(/items-\d+/, `items-${index}`);
                    input.setAttribute('name', newName);
                }
                
                if (id) {
                    const newId = id.replace(/items-\d+/, `items-${index}`);
                    input.setAttribute('id', newId);
                }
                
                // Clear values
                if (input.type !== 'hidden' || input.id.includes('id')) {
                    input.value = '';
                }
            });
            
            // Add the new item to the container
            container.appendChild(newItem);
            
            // Setup event listeners
            setupInputListeners();
            setupRemoveButtons();
            calculateTotals();
        });
        
        // Setup input listeners for amounts
        function setupInputListeners() {
            document.querySelectorAll('.debit-amount, .credit-amount').forEach(function(input) {
                input.addEventListener('input', function() {
                    calculateTotals();
                    
                    // If one side has a value, clear the other side
                    const parent = this.closest('.transaction-item');
                    const debitInput = parent.querySelector('.debit-amount');
                    const creditInput = parent.querySelector('.credit-amount');
                    
                    if (this.classList.contains('debit-amount') && parseFloat(this.value) > 0) {
                        creditInput.value = '';
                    } else if (this.classList.contains('credit-amount') && parseFloat(this.value) > 0) {
                        debitInput.value = '';
                    }
                });
            });
        }
        
        // Initial setup
        setupRemoveButtons();
        setupInputListeners();
        calculateTotals();
    });
</script>
{% endblock %}