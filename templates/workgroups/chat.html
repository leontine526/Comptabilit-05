{% extends "base.html" %}

{% block title %}Chat - {{ workgroup.name }}{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/social.css') }}">
<style>
    .chat-container {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        height: calc(100vh - 200px);
        min-height: 500px;
        display: flex;
        flex-direction: column;
    }
    
    .chat-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .chat-user-info {
        display: flex;
        align-items: center;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background-color: #f8f9fa;
    }
    
    .chat-input-area {
        padding: 1rem;
        background-color: #fff;
        border-top: 1px solid #dee2e6;
    }
    
    .chat-message {
        display: flex;
        margin-bottom: 1rem;
        max-width: 80%;
    }
    
    .chat-message-in {
        align-self: flex-start;
    }
    
    .chat-message-out {
        align-self: flex-end;
        margin-left: auto;
        flex-direction: row-reverse;
    }
    
    .message-avatar {
        margin-right: 0.5rem;
    }
    
    .chat-message-out .message-avatar {
        margin-right: 0;
        margin-left: 0.5rem;
    }
    
    .message-content {
        background-color: #fff;
        border-radius: 18px;
        padding: 0.75rem 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        position: relative;
    }
    
    .chat-message-in .message-content {
        background-color: #e9ecef;
    }
    
    .chat-message-out .message-content {
        background-color: #d6e8ff;
    }
    
    .message-text {
        margin-bottom: 0.25rem;
        word-break: break-word;
    }
    
    .message-time {
        text-align: right;
        font-size: 0.75rem;
        color: #6c757d;
    }
    
    .typing-indicator {
        padding: 0.5rem;
        font-style: italic;
        color: #6c757d;
        display: none;
    }
    
    .message-files {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .message-file {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 0.5rem;
        display: flex;
        align-items: center;
        max-width: 100%;
    }
    
    .message-file i {
        font-size: 1.25rem;
        margin-right: 0.5rem;
    }
    
    .message-file a {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .chat-members {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .member-item {
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
    }
    
    .member-info {
        margin-left: 0.75rem;
        flex: 1;
    }
    
    .member-role {
        background-color: #e9ecef;
        border-radius: 12px;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    
    @media (max-width: 767.98px) {
        .chat-container {
            height: calc(100vh - 150px);
        }
        .chat-message {
            max-width: 90%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- Menu latéral -->
        <div class="col-md-3 d-none d-md-block">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">{{ workgroup.name }}</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small">{{ workgroup.description }}</p>
                    <div class="list-group mt-3">
                        <a href="{{ url_for('workgroup_view', workgroup_id=workgroup.id) }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-info-circle me-2"></i> Vue d'ensemble
                        </a>
                        <a href="{{ url_for('workgroup_notes', workgroup_id=workgroup.id) }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-journal-text me-2"></i> Notes
                        </a>
                        <a href="{{ url_for('workgroup_posts', workgroup_id=workgroup.id) }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-newspaper me-2"></i> Publications
                        </a>
                        <a href="{{ url_for('workgroup_chat', workgroup_id=workgroup.id) }}" class="list-group-item list-group-item-action active">
                            <i class="bi bi-chat-dots me-2"></i> Chat
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Membres</h5>
                    <span class="badge bg-primary rounded-pill">{{ workgroup.members.count() }}</span>
                </div>
                <div class="card-body p-0">
                    <div class="chat-members">
                        {% for member in workgroup.members %}
                            <div class="member-item">
                                <div class="avatar">
                                    <span class="avatar-initial rounded-circle bg-primary">
                                        {{ member.user.username[0]|upper }}
                                    </span>
                                </div>
                                <div class="member-info">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>{{ member.user.username }}</span>
                                        <span class="user-status-indicator text-secondary" data-user-id="{{ member.user.id }}" title="Hors ligne">
                                            <i class="bi bi-circle-fill"></i>
                                        </span>
                                    </div>
                                    {% if member.is_admin %}
                                        <span class="member-role">Admin</span>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Zone de chat principale -->
        <div class="col-md-9">
            <div class="d-md-none mb-3">
                <a href="{{ url_for('workgroup_view', workgroup_id=workgroup.id) }}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Retour au groupe
                </a>
            </div>
            
            <div class="chat-container" data-room-id="workgroup_{{ workgroup.id }}">
                <div class="chat-header">
                    <div class="chat-user-info">
                        <div class="avatar me-2">
                            <span class="avatar-initial rounded-circle bg-primary">
                                {{ workgroup.name[0]|upper }}
                            </span>
                        </div>
                        <div>
                            <h5 class="mb-0">{{ workgroup.name }}</h5>
                            <small class="text-muted">{{ workgroup.members.count() }} membres</small>
                        </div>
                    </div>
                    <div>
                        <button type="button" class="btn btn-outline-primary btn-sm d-md-none" data-bs-toggle="modal" data-bs-target="#members-modal">
                            <i class="bi bi-people"></i> Membres
                        </button>
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="chat-message {% if message.user_id == current_user.id %}chat-message-out{% else %}chat-message-in{% endif %}">
                                <div class="message-avatar">
                                    <div class="avatar {% if message.user_id == current_user.id %}bg-primary{% else %}bg-secondary{% endif %}">
                                        <span class="avatar-initial">{{ message.user.username[0]|upper }}</span>
                                    </div>
                                </div>
                                <div class="message-content">
                                    <div class="message-text">{{ message.content }}</div>
                                    {% if message.files %}
                                        <div class="message-files">
                                            {% for file in message.files %}
                                                <div class="message-file">
                                                    <i class="bi bi-file-earmark"></i>
                                                    <a href="{{ file.url }}" target="_blank">{{ file.name }}</a>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="message-time">
                                        <small class="text-muted">{{ message.created_at.strftime('%H:%M') }}</small>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted my-5">
                            <i class="bi bi-chat-dots display-4"></i>
                            <p class="mt-3">Aucun message pour le moment.<br>Commencez la conversation !</p>
                        </div>
                    {% endif %}
                    
                    <div class="typing-indicator" id="typing-indicator"></div>
                </div>
                
                <div class="chat-input-area">
                    <form id="chat-form">
                        <div class="input-group">
                            <button class="btn btn-outline-secondary" type="button" id="attach-file-btn" data-bs-toggle="modal" data-bs-target="#attach-file-modal">
                                <i class="bi bi-paperclip"></i>
                            </button>
                            <input type="text" class="form-control" id="chat-input" placeholder="Écrire un message..." aria-label="Message">
                            <button class="btn btn-primary" type="submit" id="send-message-btn">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour les membres (mobile) -->
<div class="modal fade" id="members-modal" tabindex="-1" aria-labelledby="members-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="members-modal-label">Membres du groupe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body p-0">
                <div class="chat-members">
                    {% for member in workgroup.members %}
                        <div class="member-item">
                            <div class="avatar">
                                <span class="avatar-initial rounded-circle bg-primary">
                                    {{ member.user.username[0]|upper }}
                                </span>
                            </div>
                            <div class="member-info">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>{{ member.user.username }}</span>
                                    <span class="user-status-indicator text-secondary" data-user-id="{{ member.user.id }}" title="Hors ligne">
                                        <i class="bi bi-circle-fill"></i>
                                    </span>
                                </div>
                                {% if member.is_admin %}
                                    <span class="member-role">Admin</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour joindre un fichier -->
<div class="modal fade" id="attach-file-modal" tabindex="-1" aria-labelledby="attach-file-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="attach-file-modal-label">Joindre un fichier</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <form id="file-upload-form">
                    <div class="mb-3">
                        <label for="chat-file" class="form-label">Sélectionner un fichier</label>
                        <input class="form-control" type="file" id="chat-file">
                    </div>
                    <div class="mb-3">
                        <div id="file-info" class="mt-3 d-none">
                            <div class="alert alert-info">
                                <i class="bi bi-file-earmark me-2"></i>
                                <span id="file-name"></span>
                                (<span id="file-size"></span>)
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirm-file">Joindre</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script src="{{ url_for('static', filename='js/realtime.js') }}"></script>
<script>
    // Variables
    let chatInput = null;
    let chatForm = null;
    let chatMessages = null;
    let currentFile = null;
    let fileModal = null;
    let isScrolled = false;
    
    // Initialisation lors du chargement du document
    document.addEventListener('DOMContentLoaded', function() {
        // Initialise les références
        chatInput = document.getElementById('chat-input');
        chatForm = document.getElementById('chat-form');
        chatMessages = document.getElementById('chat-messages');
        fileModal = new bootstrap.Modal(document.getElementById('attach-file-modal'));
        
        // Initialise Socket.IO
        initializeSocketIO({{ current_user.id }});
        
        // Définit les gestionnaires d'événements
        setupEventHandlers();
        
        // Fait défiler vers le bas pour montrer les messages les plus récents
        scrollToBottom();
    });
    
    // Configure les gestionnaires d'événements
    function setupEventHandlers() {
        // Gestionnaire pour l'envoi de message
        chatForm.addEventListener('submit', function(event) {
            event.preventDefault();
            sendMessage();
        });
        
        // Gestionnaire pour la frappe au clavier
        chatInput.addEventListener('input', function() {
            sendTypingEvent('workgroup_{{ workgroup.id }}');
        });
        
        // Gestionnaire pour le scroll des messages
        chatMessages.addEventListener('scroll', function() {
            const isAtBottom = chatMessages.scrollHeight - chatMessages.scrollTop <= chatMessages.clientHeight + 50;
            isScrolled = !isAtBottom;
        });
        
        // Gestionnaire pour l'information de fichier
        const fileInput = document.getElementById('chat-file');
        if (fileInput) {
            fileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    currentFile = file;
                    
                    // Affiche les informations du fichier
                    const fileInfo = document.getElementById('file-info');
                    fileInfo.classList.remove('d-none');
                    document.getElementById('file-name').textContent = file.name;
                    document.getElementById('file-size').textContent = formatFileSize(file.size);
                }
            });
        }
        
        // Gestionnaire pour la confirmation d'upload de fichier
        const confirmFileButton = document.getElementById('confirm-file');
        if (confirmFileButton) {
            confirmFileButton.addEventListener('click', function() {
                if (currentFile) {
                    uploadFile(currentFile, function(url, fileName) {
                        fileModal.hide();
                        sendFileMessage(url, fileName);
                    });
                }
            });
        }
    }
    
    // Envoie un message texte
    function sendMessage() {
        const message = chatInput.value.trim();
        
        if (message) {
            // Envoie le message via Socket.IO
            sendChatMessage(message, 'workgroup_{{ workgroup.id }}');
            
            // Réinitialise l'input
            chatInput.value = '';
            chatInput.focus();
        }
    }
    
    // Envoie un message avec fichier joint
    function sendFileMessage(fileUrl, fileName) {
        // Cette fonction devrait appeler l'API pour envoyer un message avec fichier
        // Pour l'instant, elle envoie simplement un message avec un lien
        const message = `J'ai partagé un fichier : ${fileName}\n${fileUrl}`;
        sendChatMessage(message, 'workgroup_{{ workgroup.id }}');
    }
    
    // Fait défiler le conteneur de messages vers le bas
    function scrollToBottom() {
        if (!isScrolled) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }
    
    // Formate la taille du fichier
    function formatFileSize(bytes) {
        if (bytes < 1024) {
            return bytes + ' octets';
        } else if (bytes < 1048576) {
            return (bytes / 1024).toFixed(2) + ' Ko';
        } else {
            return (bytes / 1048576).toFixed(2) + ' Mo';
        }
    }
    
    // Upload un fichier
    function uploadFile(file, callback) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', 'file');
        
        fetch('/api/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                callback(data.url, file.name);
            } else {
                showToast('Erreur lors de l\'upload: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showToast('Erreur de connexion lors de l\'upload', 'danger');
        });
    }
</script>
{% endblock %}